apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "frontcache.fullname" . }}-loadgen-script
  labels:
    {{- include "frontcache.labels" . | nindent 4 }}
    app.kubernetes.io/component: loadgen
data:
  loadgen.py: |
    import asyncio
    import random
    import frontcache

    ROUTER = "http://{{ include "frontcache.fullname" . }}-router:{{ .Values.router.service.port }}"
    FILE_COUNT = {{ .Values.loadgen.fileCount }}
    FILE_SIZE = {{ .Values.loadgen.fileSizeMB }} * 1024 * 1024
    SLEEP = {{ .Values.loadgen.sleepSeconds }}
    FILES = [f"s3://test/file{i}.bin" for i in range(1, FILE_COUNT + 1)]

    async def main():
        print(f"Connecting to {ROUTER}")
        client = await frontcache.connect(ROUTER)
        print(f"Connected, {FILE_COUNT} files x {FILE_SIZE} bytes, sleep={SLEEP}s")
        i = 0
        while True:
            f = random.choice(FILES)
            offset = random.randrange(0, FILE_SIZE, 4096)
            try:
                nbytes = 0
                async for chunk in client.stream_range(f, offset=offset, length=4096, version="v1"):
                    nbytes += len(chunk)
                i += 1
                if i % 100 == 0:
                    print(f"Completed {i} reads")
            except Exception as e:
                print(f"Error reading {f} offset={offset}: {e}")
            await asyncio.sleep(SLEEP)

    asyncio.run(main())
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "frontcache.fullname" . }}-loadgen
  labels:
    {{- include "frontcache.labels" . | nindent 4 }}
    app.kubernetes.io/component: loadgen
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "frontcache.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: loadgen
  template:
    metadata:
      labels:
        {{- include "frontcache.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: loadgen
    spec:
      initContainers:
        - name: seed
          image: minio/mc:latest
          command:
            - /bin/sh
            - -c
            - |
              until mc alias set local http://{{ include "frontcache.fullname" . }}-minio:9000 {{ .Values.minio.rootUser }} {{ .Values.minio.rootPassword }}; do
                echo "Waiting for MinIO..."
                sleep 2
              done
              {{- range .Values.minio.buckets }}
              mc mb --ignore-existing local/{{ . }}
              {{- end }}
              for i in $(seq 1 {{ .Values.loadgen.fileCount }}); do
                echo "Seeding test/file${i}.bin ({{ .Values.loadgen.fileSizeMB }}MB)..."
                head -c $(( {{ .Values.loadgen.fileSizeMB }} * 1048576 )) /dev/urandom > /tmp/file${i}.bin
                mc cp --attr "x-frontcache-version=v1" /tmp/file${i}.bin local/test/file${i}.bin
              done
              echo "Seeding complete."
      containers:
        - name: loadgen
          image: {{ include "frontcache.image" . }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python3", "-u", "/scripts/loadgen.py"]
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OTEL_SERVICE_NAME
              value: "frontcache_client"
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "service.instance.id=$(POD_NAME)"
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://{{ include "frontcache.fullname" . }}-otel-collector:4317"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: {{ include "frontcache.fullname" . }}-loadgen-script
